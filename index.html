<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Missive Sidebar Integration</title>
  <script src="https://integrations.missiveapp.com/missive.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 12px;
      margin: 0;
      font-size: 14px;
    }
    h1 { font-size: 16px; margin-bottom: 6px; }
    h2 { font-size: 14px; margin-top: 14px; }
    .muted { color: #666; font-size: 12px; }
    .message {
      border-top: 1px solid #eee;
      padding-top: 8px;
      margin-top: 8px;
    }
    button {
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
    }
    pre {
      background: #f6f8fa;
      padding: 8px;
      font-size: 11px;
      max-height: 200px;
      overflow: auto;
    }
  </style>
</head>
<body>

<h1>Missive Sidebar Integration</h1>
<div class="muted">Stable baseline (forced re-fetch)</div>

<h2>Conversation</h2>
<div><strong>ID:</strong> <span id="cid">—</span></div>
<button id="openConv" disabled>Open conversation</button>

<h2>Messages</h2>
<div id="messages">Waiting…</div>

<h2>Raw payload (debug)</h2>
<pre id="payload">Waiting…</pre>

<script>
  let activeConversationId = null;

  function renderConversation(conversation) {
    document.getElementById("cid").textContent = conversation.id;

    const openBtn = document.getElementById("openConv");
    openBtn.disabled = false;
    openBtn.onclick = () => Missive.openConversation(conversation.id);

    document.getElementById("payload").textContent =
      JSON.stringify(conversation, null, 2);

    const container = document.getElementById("messages");
    container.innerHTML = "";

    const messages = Array.isArray(conversation.messages)
      ? [...conversation.messages]
      : [];

    messages.sort((a, b) => (a.created_at || 0) - (b.created_at || 0));

    messages.forEach((msg, index) => {
      const div = document.createElement("div");
      div.className = "message";

      const sender = document.createElement("div");
      sender.className = "muted";
      sender.textContent = msg.author?.name || "Unknown sender";

      const btn = document.createElement("button");
      btn.textContent = `Message ${index + 1}`;
      btn.onclick = () => {
        // Stable navigation: open conversation, let Missive handle scroll
        Missive.openConversation(conversation.id);
      };

      div.appendChild(sender);
      div.appendChild(btn);
      container.appendChild(div);
    });

    if (messages.length === 0) {
      container.textContent = "No messages found.";
    }
  }

  function fetchAndRender(conversationId) {
    Missive.fetchConversations([conversationId], { messages: true })
      .then(conversations => {
        if (conversations && conversations[0]) {
          renderConversation(conversations[0]);
        }
      });
  }

  Missive.on("change:conversations", (conversationIds) => {
    if (!conversationIds || !conversationIds.length) return;

    const newId = conversationIds[0];

    // Always re-fetch when conversation becomes active
    if (newId !== activeConversationId) {
      activeConversationId = newId;
      fetchAndRender(newId);
    }
  });
</script>

</body>
</html>
