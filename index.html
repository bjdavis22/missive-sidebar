// ================================
// Missive Sidebar Integration
// Baseline 2.03 — drafts + markdown link extraction
// ================================

const BASELINE_VERSION = "2.03";

// --------------------
// Utilities
// --------------------

function escapeHtml(str = "") {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// Extract links from text:
// 1. Markdown links [label](url)
// 2. Raw URLs (http(s) + drafts)
function extractLinks(text = "") {
  const results = [];
  const seen = new Set();

  if (!text) return results;

  // --- Markdown links ---
  const mdRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
  let mdMatch;
  while ((mdMatch = mdRegex.exec(text)) !== null) {
    const url = mdMatch[2].trim();
    if (!seen.has(url)) {
      seen.add(url);
      results.push(url);
    }
  }

  // --- Raw URLs ---
  const rawRegex = /\b(?:https?:\/\/|drafts:\/\/)[^\s<>"']+/gi;
  const rawMatches = text.match(rawRegex) || [];
  for (const url of rawMatches) {
    if (!seen.has(url)) {
      seen.add(url);
      results.push(url);
    }
  }

  return results;
}

function renderLink(url) {
  const safeUrl = escapeHtml(url);
  return `<li><a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeUrl}</a></li>`;
}

function renderToggle(title, itemsHtml) {
  return `
    <details>
      <summary>${title}</summary>
      <ul>
        ${itemsHtml}
      </ul>
    </details>
  `;
}

// --------------------
// Main render
// --------------------

function renderSidebar(payload) {
  const conversation = payload.conversation || {};
  const messages = payload.messages || [];

  let html = `
    <div>
      <h2>Missive Sidebar Integration</h2>
      <div style="opacity:0.6;font-size:12px;">Baseline ${BASELINE_VERSION}</div>
    </div>
  `;

  // --------------------
  // Conversation
  // --------------------

  html += `
    <section>
      <h3>Conversation</h3>
      <div>ID: ${conversation.id || "—"}</div>
      ${
        conversation.link
          ? `<div><a href="${escapeHtml(conversation.link)}" target="_blank">Open conversation in Missive →</a></div>`
          : ""
      }
    </section>
  `;

  // --------------------
  // Messages (baseline ordering preserved)
  // --------------------

  html += `<section><h3>Missive Messages</h3>`;

  messages.forEach((msg) => {
    html += `
      <div style="margin-bottom:12px;">
        <strong>${escapeHtml(msg.subject || "Message")}</strong><br/>
        <a href="${escapeHtml(msg.link)}" target="_blank">Open message in Missive →</a>
    `;

    const bodyText = msg.body || msg.preview || "";
    const links = extractLinks(bodyText);

    const webLinks = links.filter((u) => u.startsWith("http"));
    const draftsLinks = links.filter((u) => u.startsWith("drafts://"));

    if (draftsLinks.length) {
      html += renderToggle(
        "Drafts App links",
        draftsLinks.map(renderLink).join("")
      );
    }

    if (webLinks.length) {
      html += renderToggle(
        "Web links",
        webLinks.map(renderLink).join("")
      );
    }

    html += `</div>`;
  });

  html += `</section>`;

  // --------------------
  // Debug payload (unchanged)
  // --------------------

  html += `
    <section>
      <h3>Raw payload (debug)</h3>
      <pre>${escapeHtml(JSON.stringify(payload, null, 2))}</pre>
    </section>
  `;

  return html;
}

// --------------------
// Missive entry point
// --------------------

Missive.renderSidebar(renderSidebar);
