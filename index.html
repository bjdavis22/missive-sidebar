/**
 * Missive Sidebar Integration
 * Version 2.08 — conversation links restored
 */

const APP_NAME = "Links";

/* ---------- URL extraction ---------- */

function extractUrls(text) {
  if (!text) return [];

  const urlRegex =
    /\bhttps?:\/\/[^\s<>"')\]]+/gi;

  return text.match(urlRegex) || [];
}

function isDraftsUrl(url) {
  return url.startsWith("drafts://");
}

/* ---------- Rendering helpers ---------- */

function renderLinksSection(title, links) {
  if (!links.length) return "";

  const items = links
    .map(
      (url) =>
        `<li><a href="${url}" target="_blank">${url}</a></li>`
    )
    .join("");

  return `
    <details open>
      <summary><strong>${title}</strong></summary>
      <ul>${items}</ul>
    </details>
  `;
}

/* ---------- Core renderer ---------- */

function renderSidebar(data) {
  const conversation = data.conversation;
  const messages = data.messages || [];

  /* ----- Conversation-level aggregation ----- */

  const conversationUrls = new Set();

  messages.forEach((msg) => {
    extractUrls(msg.body || "").forEach((url) =>
      conversationUrls.add(url)
    );
  });

  const conversationDrafts = [];
  const conversationWeb = [];

  [...conversationUrls].forEach((url) => {
    if (isDraftsUrl(url)) {
      conversationDrafts.push(url);
    } else {
      conversationWeb.push(url);
    }
  });

  /* ----- Message-level rendering ----- */

  const messageSections = messages
    .map((msg, index) => {
      const urls = extractUrls(msg.body || []);
      if (!urls.length) return "";

      const drafts = urls.filter(isDraftsUrl);
      const web = urls.filter((u) => !isDraftsUrl(u));

      return `
        <details>
          <summary>
            Message ${index + 1} — ${msg.author?.name || "Unknown sender"}
          </summary>
          ${renderLinksSection("Drafts / App links", drafts)}
          ${renderLinksSection("Web links", web)}
        </details>
      `;
    })
    .join("");

  /* ----- Final HTML ----- */

  return `
    <div>
      <h2>Missive Sidebar Integration</h2>
      <p><em>Version 2.08 — conversation links restored</em></p>

      <details open>
        <summary><strong>Conversation</strong></summary>
        <p>
          <a href="${conversation.link}" target="_blank">
            Open conversation in Missive
          </a>
        </p>
        ${renderLinksSection("Drafts / App links", conversationDrafts)}
        ${renderLinksSection("Web links", conversationWeb)}
      </details>

      <hr />

      <details open>
        <summary><strong>Missive Messages</strong></summary>
        ${messageSections || "<p>No links found.</p>"}
      </details>
    </div>
  `;
}

/* ---------- Missive hook ---------- */

Missive.renderSidebar(renderSidebar);
